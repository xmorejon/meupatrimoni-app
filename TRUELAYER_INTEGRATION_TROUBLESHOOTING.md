# TrueLayer Integration Troubleshooting Log

This document details the investigation of a critical bug where the application would hang on a blank page after returning from the TrueLayer authentication flow.

## 1. The Problem

After a user authenticated with their bank via TrueLayer, they were redirected back to the application, but were met with a blank white screen. The browser URL was `/importer/callback`, but the page was empty and the expected API call to exchange the authorization code never happened.

## 2. The Investigation: A Step-by-Step Account

The debugging process involved a series of hypotheses, tests, and incorrect assumptions before the root causes were found.

### Step 1: Initial Hypothesis (Client-Side Logic Error)

- **Assumption:** The error was within the client-side React code on the callback page.
- **Action:** Added extensive `console.log` statements to `src/app/importer/callback/page.tsx` and the `useTrueLayer` hook.
- **Result:** **No logs appeared.** This was a critical finding. It meant the component wasn't just failing; it wasn't rendering *at all*.

### Step 2: Second Hypothesis (React Context Provider Crash)

- **Assumption:** The `AuthProvider` wrapping the page was crashing during the redirect, preventing the page from rendering.
- **Action:** Removed the `<AuthProvider>` from `src/app/importer/callback/page.tsx`.
- **Result:** Still a blank page. The hypothesis was incorrect.

### Step 3: Isolating the View Layer (Minimal Test Page)

- **Assumption:** The issue might be a fundamental rendering problem, not a logic error.
- **Action:** Replaced the entire content of `src/app/importer/callback/page.tsx` with a minimal component that did nothing but log a message.
- **Result:** Still a blank page. **This proved the problem was not in the React code itself.** The issue had to be in the routing or hosting layer, which was preventing the page component from ever being served to the browser.

### Step 4: The `firebase.json` Breakthrough

- **Assumption:** The issue was in the infrastructure configuration.
- **Action:** Inspected the `firebase.json` file.
- **Result:** **Found the first root cause.** The file contained a global rewrite rule:
  ```json
  "rewrites": [
    {
      "source": "**",
      "destination": "/index.html"
    }
  ]
  ```
  This rule was incorrectly forcing Firebase Hosting to serve the main `index.html` page for *every single URL*, including the `/importer/callback` route. The browser was requesting the callback page but receiving the homepage, which explains the silent failure.
- **Fix:** Removed the entire `rewrites` section from `firebase.json`.

### Step 5: The `404 Not Found` Error

- **Assumption:** With the rewrite rule gone, the routing should work.
- **Result:** After deploying the fix, we no longer got a blank page. Instead, we got a `404 Not Found` error when navigating to `/importer/callback`.
- **Analysis:** This indicated that Firebase Hosting was now correctly trying to find a file for the route, but no such file existed. For a static Next.js site, pages are exported as `.html` files (e.g., `callback.html`).

### Step 6: The Final Fix (Client-Side Redirect)

- **Assumption:** The final piece of the puzzle was the redirect *to* the callback page.
- **Action:** Inspected `public/callback.html`, the static page that handles the initial return from TrueLayer.
- **Result:** **Found the second root cause.** The script was redirecting the user to the wrong path:
  ```javascript
  window.location.href = '/importer/callback'; // Incorrect
  ```
- **Fix:** Corrected the path to point to the actual HTML file generated by the static export:
  ```javascript
  window.location.href = '/importer/callback.html'; // Correct
  ```

## 3. Conclusion

The problem was a combination of two configuration errors:
1.  **A Firebase Hosting rule** that incorrectly served the homepage for all routes.
2.  **A client-side redirect** in `public/callback.html` that pointed to a non-existent path in a static deployment.

By systematically eliminating possibilities, from client-side logic to the hosting infrastructure, we were able to isolate and resolve both issues. This allowed the browser to correctly load `/importer/callback.html`, which then successfully triggered the `handleTrueLayerCallback` cloud function.
